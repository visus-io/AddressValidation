name: Continuous Integration

on:
    push:
        branches:
            - develop
        paths-ignore:
            - 'README.md'
            - 'docs/**'
            - '.github/workflows/docs.yml'
            - '.github/workflows/release.yml'
    
    pull_request:
        paths-ignore:
            - 'README.md'
            - 'docs/**'
            - '.github/workflows/docs.yml'
            - '.github/workflows/release.yml'

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
            SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        
        steps:
            -   name: Checkout
                uses: actions/checkout@v5
                with:
                    fetch-depth: 0
                    show-progress: false
            -   name: Install .NET SDK
                uses: actions/setup-dotnet@v5
                with:
                    global-json-file: global.json
            -   name: NuGet Cache
                uses: actions/cache@v4
                with:
                    path: ~/.nuget/packages
                    key: ${{ runner.os}}-nuget-${{ hashFiles('**/packages.lock.json') }}
                    restore-keys: ${{ runner.os }}-nuget
            -   name: Test
                run: ./build.sh Test
            -   name: Publish Test Results
                if: always()
                uses: dorny/test-reporter@v2
                with:
                    name: Test Results
                    path: .nuke/temp/TestResults/*.trx
                    reporter: dotnet-trx
                    path-replace-backslashes: true
